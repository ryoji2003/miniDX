# 開発仕様書: 会津大学MiniDXプロジェクト - シフト管理・介護記録システム

## 1. プロジェクト概要

### 1.1 目的とゴール
河東デイサービスセンター向けのシフト管理および介護記録システムの開発。
本プロジェクトは以下を目指す：
- スタッフのシフト作成・管理業務の効率化
- 制約条件を考慮した柔軟なシフト自動生成
- 将来的なAI介護記録機能の実装

### 1.2 技術スタック
- **フロントエンド**: React.js
- **UIフレームワーク**: カレンダー形式のインターフェース
- **デプロイ形式**: Webアプリケーション（クラウドベース）
- **AI機能**: ChatGPT/Gemini等のAPI（従量課金型）
- **要件**: モダンブラウザ対応、低スペックPC動作可能

### 1.3 プロジェクトステータス
- **現在**: React版WIP（Work in Progress）
- **削除済み**: Static版（HTML/JS版）は廃止・削除済み
- **次回確認**: 2025年1月中旬（1月14日頃）
- **完了目標**: 2025年1月中旬〜2月

---

## 2. アーキテクチャとファイル構成

### 2.1 想定ディレクトリマップ

```
miniDX/
├── src/
│   ├── components/
│   │   ├── ShiftManagement/
│   │   │   ├── CalendarView.jsx          # カレンダー形式のシフト表示（採用決定）
│   │   │   ├── StaffAssignment.jsx       # スタッフ配置管理
│   │   │   ├── ConstraintInput.jsx       # 制約条件入力（希望休、研修等）
│   │   │   └── ShiftGenerator.jsx        # シフト自動生成ロジック
│   │   ├── CareRecord/
│   │   │   ├── VoiceInput.jsx            # 音声入力コンポーネント
│   │   │   ├── RecordSummary.jsx         # AI要約表示
│   │   │   └── UserSelector.jsx          # 利用者選択
│   │   └── Common/
│   │       ├── Header.jsx
│   │       └── Navigation.jsx
│   ├── services/
│   │   ├── shiftAlgorithm.js             # シフト作成アルゴリズム
│   │   ├── aiService.js                  # AI API連携
│   │   └── authService.js                # 認証（ID/PASS）
│   ├── utils/
│   │   ├── validation.js
│   │   └── dateHelpers.js
│   ├── App.jsx
│   └── index.jsx
├── public/
└── package.json
```

### 2.2 コンポーネント相関図

```
App.jsx
  └── Router
      ├── ShiftManagement (メイン機能)
      │   ├── CalendarView (UI: カレンダー形式)
      │   │   └── StaffAssignment
      │   ├── ConstraintInput (制約条件入力)
      │   └── ShiftGenerator (自動生成実行)
      │       └── shiftAlgorithm.js (ロジック)
      │
      └── CareRecord (将来機能)
          ├── UserSelector
          ├── VoiceInput
          │   └── aiService.js (API連携)
          └── RecordSummary
```

### 2.3 データフロー
1. **制約条件入力** → `ConstraintInput`で希望休・研修等を設定
2. **自動生成実行** → `shiftAlgorithm.js`が残りの人員を役職に割り当て
3. **カレンダー表示** → `CalendarView`で結果を可視化
4. **手動調整** → `StaffAssignment`でドラッグ&ドロップ等で微調整

---

## 3. 要件定義（Based on 2025_12_22_議事録）

### 3.1 決定されたUI仕様

#### ✅ 採用決定: カレンダー形式（デザイン案2）
- **理由**: 「見やすく、直感的に誰が入るか分かりやすい」
- **表示内容**:
  - 日付ごとにスタッフ名と担当業務を表示
  - 出勤状況が一目で把握できる
  - クリック/ホバーで詳細情報を表示

#### ❌ 不採用: リスト形式（デザイン案1）
- Static版含め、リスト形式の実装は削除済み

### 3.2 シフト管理機能リスト

#### 【優先度：高】必須機能

- [ ] **1. 役職定義と制約管理**
  - 役職: 看護、相談員、訓練、特浴、フロ（一般入浴）、リーダー、サブリーダー、運転（送迎）
  - 制約ルール:
    - 看護: 毎日必ず1名以上
    - 運転: 6名以上必要
    - 入浴介助: 約6名（利用者数による）
    - 訓練: どの職種でも担当可能
    - 運転と訓練は兼務可、運転と入浴介助は基本的に兼務不可

- [ ] **2. 制約条件優先型シフト生成**
  - **Step 1**: 希望休の入力
  - **Step 2**: 確定事項（研修、事務等）の入力
  - **Step 3**: 残りのフリー人員を必要な役職に自動割り当て
  - **ロジック**: 全自動から条件固定型へ変更

- [ ] **3. カレンダービュー実装**
  - 月次カレンダー表示
  - 各日付セルに「スタッフ名」「担当業務」を表示
  - 色分けで役職を視覚化（例: 看護=青、運転=緑）

- [ ] **4. 手動調整機能**
  - スタッフのドラッグ&ドロップによる配置変更
  - 制約違反時の警告表示（例: 看護0名、運転5名）

#### 【優先度：中】推奨機能

- [ ] **5. シフトパターンテンプレート**
  - よく使うシフトパターンを保存
  - テンプレートからの一括生成

- [ ] **6. 履歴管理**
  - 過去のシフトデータを参照
  - コピー機能（先月のシフトをベースに作成）

#### 【優先度：低】将来機能

- [ ] **7. AI介護記録（ケアダイアリー）**
  - 音声入力による記録作成
  - AIによる自動要約・整理
  - 利用者ごとのデータ蓄積
  - **実装条件**: インフラ整備後（Wi-Fi、端末）
  - **アクセス**: Webブラウザ + ID/PASS認証
  - **課題認識**: 
    - ハードウェア不足（タブレット/スマホ）
    - Wi-Fi環境未整備
    - スタッフのITリテラシー差

---

## 4. 現状分析と開発ロードマップ

### 4.1 現状の実装状況（想定）

#### ✅ 実装済み（推定）
- React環境のセットアップ
- 基本的なコンポーネント構造
- ルーティング設定

#### ⚠️ 部分実装（要確認）
- カレンダーUIの基本骨格
- シフトデータの状態管理（useState/useContext）

#### ❌ 未実装（要対応）
- **制約条件優先型シフト生成アルゴリズム**（最重要）
- カレンダー形式の詳細UI（スタッフ名・業務表示）
- 手動調整機能（ドラッグ&ドロップ）
- AI介護記録機能（全体）

### 4.2 実装ステップ

#### Phase 1: コア機能実装（〜1月中旬）

**Step 1-1: シフト生成アルゴリズムの実装**（最優先）
```javascript
// services/shiftAlgorithm.js
function generateShift(staff, constraints) {
  // 1. 希望休を除外
  // 2. 確定事項（研修等）を配置
  // 3. 残りのフリー人員を必要役職に割り当て
  // 4. 制約チェック（看護1名以上、運転6名以上等）
}
```

**Step 1-2: カレンダーUI実装**
- ライブラリ選定: `react-big-calendar` or `FullCalendar for React`
- 日付セル内のスタッフ表示レイアウト
- 色分けスタイリング

**Step 1-3: 制約条件入力UI**
- 希望休入力フォーム
- 研修・事務等の確定事項入力
- バリデーション実装

**Step 1-4: 手動調整機能**
- `react-dnd`等を使用したドラッグ&ドロップ
- リアルタイム制約チェック

#### Phase 2: 拡張機能（1月中旬〜2月）

**Step 2-1: AI介護記録プロトタイプ**
- Web Speech APIによる音声入力
- ChatGPT/Gemini APIとの連携
- 要約結果の表示

**Step 2-2: 認証機能**
- ID/PASSログイン画面
- セッション管理

**Step 2-3: マニュアル作成**
- システム導入マニュアル
- 設定マニュアル
- 引き継ぎ資料

### 4.3 具体的な作業タスク（萩原担当）

#### 🔥 緊急対応（1月14日まで）
1. [ ] シフト作成アルゴリズムの修正（制約条件優先型へ変更）
2. [ ] カレンダー形式UI実装
3. [ ] 制約入力フォーム実装

#### 📝 通常対応（1月中旬〜2月）
4. [ ] 介護記録機能（音声入力・要約）のプロトタイプ実装
5. [ ] システム導入・設定マニュアル作成準備
6. [ ] 最終調整および引き継ぎ

---

## 5. 技術仕様詳細

### 5.1 シフト生成アルゴリズム仕様

#### 入力データ構造
```javascript
// スタッフデータ
const staff = [
  {
    id: 1,
    name: "山田太郎",
    qualifications: ["看護", "運転"], // 可能な役職
    requestedDaysOff: ["2025-01-05", "2025-01-12"], // 希望休
  },
  // ...
];

// 制約条件
const constraints = {
  fixedAssignments: [
    { date: "2025-01-10", staffId: 3, role: "研修" },
    // ...
  ],
  dailyRequirements: {
    nursing: { min: 1 }, // 看護は最低1名
    driving: { min: 6 }, // 運転は最低6名
    bathing: { min: 6 }, // 入浴介助は約6名
  },
};
```

#### 出力データ構造
```javascript
const generatedShift = {
  "2025-01-05": [
    { staffId: 1, role: "看護" },
    { staffId: 2, role: "運転" },
    { staffId: 2, role: "訓練" }, // 兼務可能
    // ...
  ],
  // ...
  warnings: [
    { date: "2025-01-08", message: "運転スタッフが5名（6名必要）" }
  ]
};
```

#### アルゴリズムフロー
```
1. 全日程のスタッフリストを初期化
2. For each day:
   a. 希望休のスタッフを除外
   b. 確定事項（研修等）を配置
   c. 残りのフリースタッフから優先度順に配置:
      - 看護（必須1名以上）
      - 運転（必須6名以上）
      - 入浴介助（約6名）
      - その他の役職
   d. 制約チェック実行
   e. 警告がある場合は記録
3. 結果を返す
```

### 5.2 カレンダーUI仕様

#### レイアウト
```
[<< 前月]  2025年1月  [次月 >>]
┌────┬────┬────┬────┬────┬────┬────┐
│ 日 │ 月 │ 火 │ 水 │ 木 │ 金 │ 土 │
├────┼────┼────┼────┼────┼────┼────┤
│    │    │    │  1 │  2 │  3 │  4 │
│    │    │    │田中│佐藤│鈴木│高橋│
│    │    │    │看護│運転│フロ│運転│
├────┼────┼────┼────┼────┼────┼────┤
│  5 │  6 │ ... 
│山田│伊藤│
│運転│看護│
│訓練│    │
└────┴────┴────┴────┴────┴────┴────┘
```

#### インタラクション
- **クリック**: 詳細ポップアップ表示
- **ドラッグ**: スタッフの移動（手動調整）
- **右クリック**: コンテキストメニュー（削除、役職変更等）

### 5.3 AI介護記録仕様

#### 機能フロー
```
1. 利用者選択（ドロップダウン）
2. 音声入力ボタンをクリック
3. 音声→テキスト変換（Web Speech API）
4. AI API呼び出し（要約・構造化）
5. 結果表示 + データベース保存
```

#### API連携例
```javascript
// services/aiService.js
async function summarizeCareRecord(text, userName) {
  const response = await fetch('/api/ai/summarize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      text: text,
      user: userName,
      date: new Date().toISOString(),
    }),
  });
  return await response.json();
}
```

#### 認証
- ログイン画面（ID/PASS）
- セッションベース認証
- 役割ベースアクセス制御（RBAC）

---

## 6. 注意事項

### 6.1 コードクリーンアップ

#### ❌ 削除対象
- Static版（HTML/JS）関連のファイル・フォルダ
- リスト形式UI関連のコンポーネント（採用されなかったデザイン案1）
- 古いシフト生成ロジック（全自動型）

#### ✅ 保持対象
- React版のコンポーネント構造
- 状態管理ロジック
- APIサービス層

### 6.2 パフォーマンス考慮

#### 低スペックPC対応
- サーバーサイドでの重い処理（AI要約等）
- クライアントサイドは軽量なレンダリングのみ
- 遅延ロード（Lazy Loading）の活用

#### ネットワーク最適化
- 必要最小限のAPI呼び出し
- キャッシング戦略
- オフライン時の挙動定義

### 6.3 セキュリティ

- 認証トークンの安全な管理
- XSS/CSRF対策
- 個人情報（利用者情報）の暗号化

### 6.4 コスト管理

- AI API利用料の監視（従量課金）
- 使用量制限の設定
- コスト最適化の継続的レビュー

---

## 7. テスト戦略

### 7.1 単体テスト
- [ ] シフト生成アルゴリズムのロジックテスト
- [ ] 制約チェック機能のテスト
- [ ] コンポーネントの描画テスト（Jest + React Testing Library）

### 7.2 統合テスト
- [ ] 制約入力 → シフト生成 → カレンダー表示の一連の流れ
- [ ] AI API連携テスト

### 7.3 ユーザー受入テスト（UAT）
- [ ] 渡部様・玉川様による動作確認（1月14日目処）
- [ ] 実際の業務フローでの試験運用

---

## 8. リリース計画

### 8.1 マイルストーン

| 日付 | マイルストーン | 成果物 |
|------|--------------|--------|
| 1/14頃 | Phase 1完了 | シフト管理機能（カレンダー形式） |
| 1月下旬 | Phase 2着手 | AI介護記録プロトタイプ |
| 2月初旬 | 最終調整 | バグフィックス、マニュアル作成 |
| 2月中旬 | 引き継ぎ | 完了・運用開始 |

### 8.2 引き継ぎ資料

#### 必須ドキュメント
1. [ ] システム導入マニュアル
   - 初期設定手順
   - アカウント作成方法
2. [ ] 操作マニュアル
   - シフト作成手順
   - トラブルシューティング
3. [ ] 技術ドキュメント
   - アーキテクチャ概要
   - API仕様
   - 開発環境構築手順

---

## 9. リスク管理

### 9.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| AI API障害 | 中 | フォールバック機能（手動入力） |
| 低スペックPCでの動作不良 | 高 | 軽量化、プログレッシブエンハンスメント |
| データ損失 | 高 | 定期バックアップ、冗長化 |

### 9.2 運用リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| スタッフのITリテラシー不足 | 中 | 丁寧なマニュアル、導入研修 |
| Wi-Fi環境未整備 | 低 | PC限定運用（Phase 1） |

---

## 10. 付録

### 10.1 関連リンク
- GitHub PR: https://github.com/ryoji2003/miniDX/pull/6
- 議事録: 2025_12_22_議事録.pdf

### 10.2 連絡先
- 開発担当: 萩原（会津大学）
- クライアント: 渡部様、玉川様（河東デイサービスセンター）

### 10.3 用語集
- **希望休**: スタッフが希望する休暇日
- **フリー人員**: 特定の役職に固定されていないスタッフ
- **兼務**: 複数の役職を同時に担当すること
- **制約条件優先型**: 固定事項を先に配置し、残りを自動割り当てする方式

---

## 改訂履歴
| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025/01/06 | 1.0 | 初版作成 | Claude（AI Assistant） |

---

**Note**: 本仕様書は2025年12月22日の議事録に基づき作成されました。
実際のコードベースを確認後、必要に応じて更新してください。
