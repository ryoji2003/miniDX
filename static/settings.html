<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¹ã‚¿è¨­å®š - ã‚·ãƒ•ãƒˆã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 100px; }
        
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-edit { background-color: #28a745; color: white; padding: 5px 10px; margin-right: 5px; font-size: 0.8em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†è¨­å®š</h1>

        <section>
            <h2 id="formTitle">ã‚¹ã‚¿ãƒƒãƒ•æ–°è¦ç™»éŒ²</h2>
            <input type="hidden" id="editStaffId">

            <div class="form-row">
                <div class="form-group">
                    <label>åå‰</label>
                    <input type="text" id="staffName" placeholder="ä¾‹: å±±ç”° èŠ±å­" style="width: 150px;">
                </div>
                <div class="form-group">
                    <label>æœˆé–“ä¸Šé™(æ—¥)</label>
                    <input type="number" id="staffLimit" value="20" style="width: 80px;">
                </div>
                <div class="form-group">
                    <label>è·ç¨® (çœ‹è­·å¸«è³‡æ ¼)</label>
                    <select id="staffIsNurse">
                        <option value="false">ä»‹è­·å£« (ä»–)</option>
                        <option value="true">çœ‹è­·å¸«</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>å…è¨±åŒºåˆ†</label>
                    <select id="staffLicense">
                        <option value="0">ãªã—</option>
                        <option value="1">æ™®é€šè»Šã®ã¿</option>
                        <option value="2">ãƒ¯ã‚´ãƒ³è»Šå¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é›‡ç”¨å½¢æ…‹</label>
                    <select id="staffPartTime">
                        <option value="false">å¸¸å‹¤</option>
                        <option value="true">ãƒ‘ãƒ¼ãƒˆ (é‹è»¢ä¸å¯)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç‰¹æ®Šåˆ¶ç´„</label>
                    <select id="staffOnlyTrain">
                        <option value="false">ãªã—</option>
                        <option value="true">è¨“ç·´ã¨é‹è»¢ã®ã¿å¯</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 10px;">
                <button class="btn-primary" id="saveButton" onclick="saveStaff()">ç™»éŒ²ã™ã‚‹</button>
                <button id="cancelEditBtn" onclick="resetForm()" style="display:none; background:#6c757d; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </section>

        <section>
            <h2>ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h2>
            <table id="staffTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åå‰</th>
                        <th>è·ç¨®</th>
                        <th>ä¸Šé™</th>
                        <th>å…è¨±</th>
                        <th>å±æ€§</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <script>
        window.onload = fetchStaffList;

        const LICENSE_LABELS = { 0: "-", 1: "æ™®é€šè»Š", 2: "ãƒ¯ã‚´ãƒ³" };

        // ä¸€è¦§å–å¾—
        async function fetchStaffList() {
            try {
                const res = await fetch("/api/staff");
                if (!res.ok) throw new Error("å–å¾—å¤±æ•—");
                const list = await res.json();
                
                const tbody = document.querySelector("#staffTable tbody");
                tbody.innerHTML = "";

                list.forEach(s => {
                    const tr = document.createElement("tr");
                    let attributes = [];
                    if (s.is_part_time) attributes.push("ãƒ‘ãƒ¼ãƒˆ");
                    if (s.can_only_train) attributes.push("è¨“ç·´é™å®š");

                    //çœ‹è­·å¸«ã‹ã©ã†ã‹ã‚’è¡¨ç¤º
                    const jobTitle = s.is_nurse ? "<b>çœ‹è­·å¸«</b>" : "ä»‹è­·å£«";

                    tr.innerHTML = `
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${jobTitle}</td>
                        <td>${s.work_limit}æ—¥</td>
                        <td>${LICENSE_LABELS[s.license_type]}</td>
                        <td>${attributes.join(", ")}</td>
                        <td>
                            <button class="btn-edit" onclick='editStaff(${JSON.stringify(s)})'>ç·¨é›†</button>
                            <button class="btn-danger" onclick="deleteStaff(${s.id})">å‰Šé™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
            }
        }

        // ä¿å­˜ (ç™»éŒ² or æ›´æ–°)
        async function saveStaff() {
            const id = document.getElementById("editStaffId").value;
            const data = {
                name: document.getElementById("staffName").value,
                work_limit: parseInt(document.getElementById("staffLimit").value),
                license_type: parseInt(document.getElementById("staffLicense").value),
                is_part_time: document.getElementById("staffPartTime").value === "true",
                can_only_train: document.getElementById("staffOnlyTrain").value === "true",
                is_nurse: document.getElementById("staffIsNurse").value === "true" 
            };

            if (!data.name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const method = id ? "PUT" : "POST";
            const url = id ? `/api/staff/${id}` : "/api/staff";

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert(id ? "æ›´æ–°ã—ã¾ã—ãŸ" : "ç™»éŒ²ã—ã¾ã—ãŸ");
                    resetForm();
                    fetchStaffList();
                } else {
                    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }
            } catch (e) {
                console.error(e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
            }
        }

        // å‰Šé™¤
        async function deleteStaff(id) {
            if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const res = await fetch(`/api/staff/${id}`, { method: "DELETE" });
                if (res.ok) fetchStaffList();
                else alert("å‰Šé™¤å¤±æ•—");
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡ã‚Šæ›¿ãˆ
        function editStaff(staff) {
            document.getElementById("formTitle").innerText = "ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†";
            document.getElementById("saveButton").innerText = "æ›´æ–°ã™ã‚‹";
            document.getElementById("cancelEditBtn").style.display = "inline-block";
            
            document.getElementById("editStaffId").value = staff.id;
            document.getElementById("staffName").value = staff.name;
            document.getElementById("staffLimit").value = staff.work_limit;
            document.getElementById("staffLicense").value = staff.license_type;
            document.getElementById("staffPartTime").value = staff.is_part_time.toString();
            document.getElementById("staffOnlyTrain").value = staff.can_only_train.toString();
            document.getElementById("staffIsNurse").value = staff.is_nurse.toString(); 
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById("formTitle").innerText = "ã‚¹ã‚¿ãƒƒãƒ•æ–°è¦ç™»éŒ²";
            document.getElementById("saveButton").innerText = "ç™»éŒ²ã™ã‚‹";
            document.getElementById("cancelEditBtn").style.display = "none";
            document.getElementById("editStaffId").value = "";
            
            document.getElementById("staffName").value = "";
            document.getElementById("staffLimit").value = 20;
            document.getElementById("staffLicense").value = "0";
            document.getElementById("staffPartTime").value = "false";
            document.getElementById("staffOnlyTrain").value = "false";
            document.getElementById("staffIsNurse").value = "false"; 
        }
    </script>
</body>
</html>