<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¹ã‚¿è¨­å®š - ã‚·ãƒ•ãƒˆã‚¢ãƒ—ãƒª</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* ã‚¿ãƒ– */
        .tab-menu { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-item { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; }
        .tab-item:hover { color: #007bff; }
        .tab-item.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="number"], select, input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 100px; }
        
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-edit { background-color: #28a745; color: white; padding: 5px 10px; margin-right: 5px; font-size: 0.8em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; white-space: nowrap; }
        
        /* æ—¥æ¬¡è¦ä»¶ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ */
        .req-input { width: 50px; text-align: center; }
        .req-changed { background-color: #fff3cd; } /* å¤‰æ›´ãŒã‚ã£ãŸã‚»ãƒ« */
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ãƒã‚¹ã‚¿è¨­å®š</h1>

        <div class="tab-menu">
            <div class="tab-item active" onclick="showTab('staff')">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</div>
            <div class="tab-item" onclick="showTab('task')">æ¥­å‹™ç®¡ç†</div>
            <div class="tab-item" onclick="showTab('absence')">å¸Œæœ›ä¼‘ç®¡ç†</div>
            <div class="tab-item" onclick="showTab('req')">æ—¥æ¬¡è¦ä»¶(æ )</div>
        </div>

        <div id="tab-staff" class="tab-content active">
            <section>
                <h2 id="formTitle">ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</h2>
                <input type="hidden" id="editStaffId">
                <div class="form-row">
                    <div class="form-group"><label>åå‰</label><input type="text" id="staffName" placeholder="ä¾‹: å±±ç”° èŠ±å­" style="width: 150px;"></div>
                    <div class="form-group"><label>æœˆé–“ä¸Šé™</label><input type="number" id="staffLimit" value="20" style="width: 80px;"></div>
                    <div class="form-group"><label>è·ç¨®</label><select id="staffIsNurse"><option value="false">ä»‹è­·å£« (ä»–)</option><option value="true">çœ‹è­·å¸«</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>å…è¨±åŒºåˆ†</label><select id="staffLicense"><option value="0">ãªã—</option><option value="1">æ™®é€šè»Šã®ã¿</option><option value="2">ãƒ¯ã‚´ãƒ³è»Šå¯</option></select></div>
                    <div class="form-group"><label>é›‡ç”¨å½¢æ…‹</label><select id="staffPartTime"><option value="false">å¸¸å‹¤</option><option value="true">ãƒ‘ãƒ¼ãƒˆ</option></select></div>
                    <div class="form-group"><label>ç‰¹æ®Šåˆ¶ç´„</label><select id="staffOnlyTrain"><option value="false">ãªã—</option><option value="true">è¨“ç·´ã¨é‹è»¢ã®ã¿å¯</option></select></div>
                </div>
                <div style="margin-top:10px;">
                    <button class="btn-primary" id="saveButton" onclick="saveStaff()">ç™»éŒ²ã™ã‚‹</button>
                    <button id="cancelEditBtn" onclick="resetForm()" style="display:none; background:#6c757d; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </section>
            <section>
                <h3>ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h3>
                <table id="staffTable"><thead><tr><th>ID</th><th>åå‰</th><th>è·ç¨®</th><th>ä¸Šé™</th><th>å…è¨±</th><th>å±æ€§</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            </section>
        </div>

        <div id="tab-task" class="tab-content">
            <section>
                <h2>æ¥­å‹™(ã‚¿ã‚¹ã‚¯)ç™»éŒ²</h2>
                <div class="form-row"><div class="form-group"><label>æ¥­å‹™å</label><input type="text" id="taskName" placeholder="ä¾‹: ç›¸è«‡å“¡" style="width: 200px;"></div></div>
                <button class="btn-primary" onclick="saveTask()">è¿½åŠ ã™ã‚‹</button>
            </section>
            <section>
                <h3>ç™»éŒ²æ¸ˆã¿æ¥­å‹™</h3>
                <table id="taskTable"><thead><tr><th>ID</th><th>æ¥­å‹™å</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            </section>
        </div>

        <div id="tab-absence" class="tab-content">
            <section>
                <h2>å¸Œæœ›ä¼‘ãƒªã‚¹ãƒˆ</h2>
                <button onclick="fetchAbsenceList()" style="margin-bottom:10px; background:#6c757d; color:white; font-size:0.8em;">ãƒªã‚¹ãƒˆæ›´æ–°</button>
                <table id="absenceTable">
                    <thead><tr><th>æ—¥ä»˜</th><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div id="tab-req" class="tab-content">
            <section>
                <h2>æ—¥ã”ã¨ã®å¿…è¦äººæ•°è¨­å®š</h2>
                <div class="form-row" style="align-items: center;">
                    <div class="form-group">
                        <label>å¯¾è±¡æœˆ</label>
                        <input type="month" id="reqMonth">
                    </div>
                    <button class="btn-primary" onclick="loadRequirementsTable()">è¡¨ã‚’è¡¨ç¤ºã™ã‚‹</button>
                </div>
                <p style="font-size:0.9em; color:#666;">â€»æ•°å­—ã‚’å¤‰æ›´ã—ãŸã‚‰ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                
                <div style="overflow-x: auto;">
                    <table id="reqTable">
                        </table>
                </div>
                <button class="btn-primary" onclick="saveRequirements()" style="margin-top:15px; width:100%;">ä¸€æ‹¬ä¿å­˜ã™ã‚‹</button>
            </section>
        </div>

    </div>

    <script>
        let staffMap = {};
        let tasks = [];
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®äººæ•°è¨­å®šï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãï¼‰
        const DEFAULT_COUNTS = {
            "çœ‹è­·": 1, "çœ‹è­·å¸«": 1, "çœ‹è­·æ¥­å‹™": 1,
            "ç›¸è«‡": 1, "ç›¸è«‡å“¡": 1,
            "è¨“ç·´": 1,
            "ç‰¹æµ´": 1,
            "é¢¨å‘‚": 5, "ãŠé¢¨å‘‚": 5, "å…¥æµ´": 5,
            "ãƒªãƒ¼ãƒ€ãƒ¼": 1,
            "ã‚µãƒ–ãƒªãƒ¼ãƒ€ãƒ¼": 1
        };

        window.onload = async function() {
            await fetchStaffList();
            fetchTaskList();
            fetchAbsenceList();
            // æ—¥æ¬¡è¦ä»¶ã®æœˆåˆæœŸå€¤ (æ¥æœˆ)
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('reqMonth').value = nextMonth.toISOString().slice(0, 7);
        };

        function showTab(tabName) {
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabs = ['staff', 'task', 'absence', 'req'];
            const index = tabs.indexOf(tabName);
            
            document.querySelectorAll('.tab-item')[index].classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        const LICENSE_LABELS = { 0: "-", 1: "æ™®é€šè»Š", 2: "ãƒ¯ã‚´ãƒ³" };

        // --- Staff ---
        async function fetchStaffList() {
            const res = await fetch("/api/staff");
            const list = await res.json();
            const tbody = document.querySelector("#staffTable tbody");
            tbody.innerHTML = "";
            staffMap = {};

            list.forEach(s => {
                staffMap[s.id] = s.name;
                const tr = document.createElement("tr");
                let attributes = [];
                if (s.is_part_time) attributes.push("ãƒ‘ãƒ¼ãƒˆ");
                if (s.can_only_train) attributes.push("è¨“ç·´é™å®š");
                const jobTitle = s.is_nurse ? "<b>çœ‹è­·å¸«</b>" : "ä»‹è­·å£«";
                tr.innerHTML = `<td>${s.id}</td><td>${s.name}</td><td>${jobTitle}</td><td>${s.work_limit}</td><td>${LICENSE_LABELS[s.license_type]}</td><td>${attributes.join(", ")}</td>
                    <td><button class="btn-edit" onclick='editStaff(${JSON.stringify(s)})'>ç·¨é›†</button><button class="btn-danger" onclick="deleteStaff(${s.id})">å‰Šé™¤</button></td>`;
                tbody.appendChild(tr);
            });
        }
        async function saveStaff() {
            const id = document.getElementById("editStaffId").value;
            const data = {
                name: document.getElementById("staffName").value,
                work_limit: parseInt(document.getElementById("staffLimit").value),
                license_type: parseInt(document.getElementById("staffLicense").value),
                is_part_time: document.getElementById("staffPartTime").value === "true",
                can_only_train: document.getElementById("staffOnlyTrain").value === "true",
                is_nurse: document.getElementById("staffIsNurse").value === "true"
            };
            if (!data.name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const url = id ? `/api/staff/${id}` : "/api/staff";
            const method = id ? "PUT" : "POST";
            await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
            resetForm(); fetchStaffList();
        }
        async function deleteStaff(id) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { await fetch(`/api/staff/${id}`, {method:"DELETE"}); fetchStaffList(); }}
        function editStaff(s) {
            document.getElementById("formTitle").innerText = "ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†"; document.getElementById("saveButton").innerText = "æ›´æ–°"; document.getElementById("cancelEditBtn").style.display = "inline";
            document.getElementById("editStaffId").value = s.id; document.getElementById("staffName").value = s.name; document.getElementById("staffLimit").value = s.work_limit;
            document.getElementById("staffLicense").value = s.license_type; document.getElementById("staffPartTime").value = s.is_part_time.toString();
            document.getElementById("staffOnlyTrain").value = s.can_only_train.toString(); document.getElementById("staffIsNurse").value = s.is_nurse.toString();
        }
        function resetForm() {
            document.getElementById("formTitle").innerText = "ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²"; document.getElementById("saveButton").innerText = "ç™»éŒ²"; document.getElementById("cancelEditBtn").style.display = "none";
            document.getElementById("editStaffId").value = ""; document.getElementById("staffName").value = ""; document.getElementById("staffLimit").value = 20;
            document.getElementById("staffLicense").value = 0; document.getElementById("staffPartTime").value = "false"; document.getElementById("staffOnlyTrain").value = "false"; document.getElementById("staffIsNurse").value = "false";
        }

        // --- Task ---
        async function fetchTaskList() {
            const res = await fetch("/api/task");
            tasks = await res.json(); // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            const tbody = document.querySelector("#taskTable tbody"); tbody.innerHTML = "";
            tasks.forEach(t => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${t.id}</td><td>${t.name}</td><td><button class="btn-danger" onclick="deleteTask(${t.id})">å‰Šé™¤</button></td>`;
                tbody.appendChild(tr);
            });
        }
        async function saveTask() {
            const name = document.getElementById("taskName").value; if(!name) return;
            await fetch("/api/task", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({name}) });
            document.getElementById("taskName").value = ""; fetchTaskList();
        }
        async function deleteTask(id) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { await fetch(`/api/task/${id}`, {method:"DELETE"}); fetchTaskList(); }}

        // --- Absence ---
        async function fetchAbsenceList() {
            const res = await fetch("/api/absence"); const list = await res.json();
            list.sort((a, b) => new Date(a.date) - new Date(b.date));
            const tbody = document.querySelector("#absenceTable tbody"); tbody.innerHTML = "";
            if (list.length === 0) { tbody.innerHTML = "<tr><td colspan='3' style='text-align:center'>ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>"; return; }
            list.forEach(req => {
                const staffName = staffMap[req.staff_id] || `ä¸æ˜(ID:${req.staff_id})`;
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${req.date}</td><td>${staffName}</td><td><button class="btn-danger" onclick="deleteAbsence(${req.id})">å´ä¸‹/å‰Šé™¤</button></td>`;
                tbody.appendChild(tr);
            });
        }
        async function deleteAbsence(id) { if(!confirm("å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return; await fetch(`/api/absence/${id}`, { method: "DELETE" }); fetchAbsenceList(); }

        // --- Requirements (æ—¥æ¬¡è¦ä»¶) ---
        async function loadRequirementsTable() {
            const monthStr = document.getElementById("reqMonth").value;
            if (!monthStr) return alert("æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            // 1. æ—¢å­˜ã®è¨­å®šã‚’å–å¾—
            const res = await fetch("/api/requirements");
            const allReqs = await res.json();
            
            // 2. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ (æ—¥ä»˜ + ã‚¿ã‚¹ã‚¯å)
            const table = document.getElementById("reqTable");
            table.innerHTML = "";
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            headerRow.innerHTML = "<th>æ—¥ä»˜</th>";
            
            if (tasks.length === 0) {
                table.innerHTML = "<tr><td>æ¥­å‹™(ã‚¿ã‚¹ã‚¯)ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚[æ¥­å‹™ç®¡ç†]ã‚¿ãƒ–ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</td></tr>";
                return;
            }

            tasks.forEach(t => {
                const th = document.createElement("th");
                th.innerText = t.name;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 3. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ä½œæˆ (1æ—¥ã€œæœˆæœ«)
            const tbody = document.createElement("tbody");
            const [year, month] = monthStr.split("-").map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const tr = document.createElement("tr");
                
                // æ—¥ä»˜ã‚»ãƒ«
                const tdDate = document.createElement("td");
                tdDate.innerText = `${month}/${d}`;
                tr.appendChild(tdDate);

                // ã‚¿ã‚¹ã‚¯ã”ã¨ã®å…¥åŠ›ã‚»ãƒ«
                tasks.forEach(t => {
                    const td = document.createElement("td");
                    
                    // æ—¢å­˜ã®è¨­å®šã‚’æ¢ã™
                    const savedReq = allReqs.find(r => r.date === dateStr && r.task_id === t.id);
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: ä¿å­˜æ¸ˆã¿ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°æ¥­å‹™åã«åŸºã¥ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€ãã‚Œã‚‚ãªã‘ã‚Œã°0
                    let val = 0;
                    if (savedReq) {
                        val = savedReq.count;
                    } else {
                        // ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãåˆæœŸå€¤
                        // éƒ¨åˆ†ä¸€è‡´ã‚‚å«ã‚ã¦ãƒã‚§ãƒƒã‚¯ (ä¾‹: "ãŠé¢¨å‘‚L" -> "ãŠé¢¨å‘‚"ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤5)
                        for (const key in DEFAULT_COUNTS) {
                            if (t.name.includes(key)) {
                                val = DEFAULT_COUNTS[key];
                                break;
                            }
                        }
                    }

                    // å…¥åŠ›æ¬„
                    const input = document.createElement("input");
                    input.type = "number";
                    input.className = "req-input";
                    input.value = val;
                    input.dataset.date = dateStr;
                    input.dataset.taskId = t.id;
                    
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
        }

        async function saveRequirements() {
            const inputs = document.querySelectorAll(".req-input");
            let count = 0;
            
            // å…¨ã¦ã®å…¥åŠ›å€¤ã‚’é€ä¿¡ (éåŠ¹ç‡ã ãŒç¢ºå®Ÿ)
            // æœ¬æ¥ã¯å¤‰æ›´åˆ†ã ã‘é€ã‚‹ã®ãŒè‰¯ã„
            for (const input of inputs) {
                const data = {
                    date: input.dataset.date,
                    task_id: parseInt(input.dataset.taskId),
                    count: parseInt(input.value)
                };
                
                await fetch("/api/requirements", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                count++;
            }
            alert("ä¿å­˜ã—ã¾ã—ãŸ (" + count + "ä»¶)");
        }
    </script>
</body>
</html>